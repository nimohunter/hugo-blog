<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> Talk-about-Violate-and-CAS | nimodai-blog</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.f68597611a2c172c3abc52a98561f79d3556a8efbe1cee352fd0784b21bbd5ac.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    nimodai-blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>Talk-about-Violate-and-CAS</h1>
                    <div class="post-meta">
                        <div>
                            By nimodai on <time>June 01, 2018</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/java/">Java</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <h1 id="violate-ä¸-cas-åŸå­æ€§æ¢ç©¶">Violate ä¸ CAS åŸå­æ€§æ¢ç©¶</h1>
<p>å…³äºåŸå­æ€§çš„é—®é¢˜ï¼Œå¾ˆå¤šçš„Blogè¿›è¡Œäº†åˆ†æå’Œè§£é‡Šï¼Œè¿™é‡Œåªæ˜¯æƒ³æ›´æ˜ç¡®çš„è§£é‡Šæ¸…æ¥šã€‚</p>
<h3 id="violate">Violate</h3>
<p>ä¿è¯æ‰€æœ‰çš„çº¿ç¨‹å¯è§æ€§ï¼Œä½†æ˜¯ä¸ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥åªæœ‰setå’Œgetåœºæ™¯ä½¿ç”¨violateæ˜¯éå¸¸åˆé€‚çš„ï¼Œèƒ½å¤Ÿä¿è¯ä¿®æ”¹èƒ½å¤Ÿå¿«é€Ÿçš„è¢«æ‰€æœ‰çš„çº¿ç¨‹æ‰€è¯†åˆ«ã€‚ä½†æ˜¯ä¸é€‚åˆäºgetAndOperateã€‚</p>
<p>è€Œviolateä¹‹æ‰€ä»¥å¯ä»¥è¾¾åˆ°çº¿ç¨‹å¯è§æ€§æ˜¯å› ä¸ºå†…å­˜å±éšœçš„å­˜åœ¨ï¼Œviolateä¿®é¥°çš„å¯¹è±¡ä¼šåœ¨è¯»æ“ä½œä¹‹å‰åŠ å†…å­˜å±éšœï¼Œåœ¨å†™æ“ä½œä¹‹ååŠ å†…å­˜å±éšœã€‚è€Œå†…å­˜å±éšœçš„å­˜åœ¨å°±æ˜¯æ‰“ç ´CPUçš„æŒ‡ä»¤é‡æ’åºã€‚æˆ‘ä»¬çŸ¥é“CPUä¼šåˆ©ç”¨æµæ°´è¿›è¡ŒæŒ‡ä»¤çš„é‡æ’åºï¼Œæ¥å®ç°ä¿è¯è¾“å‡ºç»“æœä¸å‘ç”Ÿæ”¹å˜çš„æƒ…å†µä¸‹è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œè€Œå†…å­˜å±éšœåˆ™æ˜¯æ‰“ç ´è¿™ç§é‡æ’åºï¼Œå†…å­˜å±éšœä¿è¯å¯¹åœ¨å†…å­˜å±éšœä¹‹å‰æŒ‡ä»¤å¿…é¡»å…¨éƒ¨æ‰§è¡Œå®Œï¼Œæ‰èƒ½æ‰§è¡Œå†…å­˜å±éšœåçš„æŒ‡ä»¤ã€‚æ‰€ä»¥åœ¨å¯¹ä¸€ä¸ªviolateå¯¹è±¡ä¿®æ”¹ä¹‹åï¼Œæ‰€æœ‰çš„ä¹‹åçš„æ“ä½œå¿…é¡»ç­‰å¾…è¿™ä¸ªviolateå¯¹è±¡ä¿®æ”¹å®Œä¹‹åæ‰èƒ½è¿›è¡Œæ“ä½œã€‚</p>
<p>å†…å­˜å±éšœçš„ç¬¬äºŒä¸ªä½œç”¨æ˜¯å‘Šè¯‰å…¶ä»–CPUè¿™å—æ•°æ®å·²ç»æ˜¯è„æ•°æ®äº†ï¼Œå¯ä»¥å¼ºåˆ¶åˆ·æ–°å…¶ä»–CPUçš„å¯¹äºè¿™ä¸ªViolateå¯¹è±¡çš„ç¼“å­˜ã€‚ä¸€ä¸ªå†™å±éšœä¼šæŠŠè¿™ä¸ªå±éšœå‰å†™å…¥çš„æ•°æ®å¼ºåˆ¶åˆ·æ–°åˆ°Cacheï¼Œè¿™æ ·ä»»ä½•è¯•å›¾è¯»å–è¯¥æ•°æ®çš„çº¿ç¨‹å°†å¾—åˆ°æœ€æ–°å€¼ã€‚</p>
<p>ä½†æ˜¯ï¼ŒViolateä¾ç„¶ä¸å…·å¤‡åŸå­æ€§ï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªviolate çš„Integerè¿›è¡Œ+1æ“ä½œï¼ŒjvmæŒ‡ä»¤ä¸ºï¼š</p>
<pre><code class="language-assembly" data-lang="assembly">mov    0xc(%r10),%r8d ; Load
inc    %r8d           ; Increment
mov    %r8d,0xc(%r10) ; Store
lock addl $0x0,(%rsp) ; StoreLoad Barrier
</code></pre><p>å…¶ä¸­Loadåˆ°StoreLoad Barrier å¹¶ä¸æ˜¯åŸå­çš„ï¼Œä¸­é—´ä»»ä½•ä¸€éƒ¨åˆ†éƒ½å¯èƒ½è¢«æ‰“æ–­ï¼Œæ¯”å¦‚åœ¨Incrementé˜¶æ®µï¼Œè¢«æ‰“æ–­ï¼Œæ•°å€¼è¢«ä¿®æ”¹ï¼Œä¹‹åå†ç»§ç»­æ‰§è¡Œå†™å›å°±å‡ºé”™äº†ã€‚</p>
<h3 id="cas">CAS</h3>
<p>CASæ“ä½œæ¥è‡ªäºJavaçš„<strong>unsafe</strong>åŒ…ï¼Œè€ŒCASçš„åŸå­æ€§ä¹Ÿæ˜¯ç”±unsafeåŒ…æä¾›çš„nativeæ–¹æ³•æä¾›çš„ã€‚CASæ˜¯æ‰€æœ‰åŸå­å˜é‡çš„åŸå­æ€§çš„åŸºç¡€ï¼ŒåŸå› æ˜¯å› ä¸ºæœ€ç»ˆçš„nativeçš„æ“ä½œä¼šæ¼”åŒ–ä¸ºä¸€æ¡CPUæŒ‡ä»¤<strong>cmpxchg</strong> ï¼Œè€Œä¸æ˜¯å¤šæ¡CPUæŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™ä¸€æ¡æŒ‡ä»¤æ˜¯ä¸ä¼šè¢«å¤šçº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„ï¼Œè€Œä¸”å¯¹äºå¤§å¤šæ•°CPUéƒ½æ˜¯æ”¯æŒçš„ï¼Œè€Œå°‘é‡ä¸æ”¯æŒçš„CPUä¼šè‡ªåŠ¨åŠ lockè¿›è¡Œä¿è¯è¿™æ¡æŒ‡ä»¤è¢«åŸå­æ‰§è¡Œã€‚</p>
<p>å…³æ³¨ä¸€ä¸‹<code>AtomicReference</code> çš„<code>compareAndSet </code>æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„åŸå­æ“ä½œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">* Atomically sets the value to the given updated value
</span><span class="cm">* if the current value {@code ==} the expected value.
</span><span class="cm">* @param expect the expected value
</span><span class="cm">* @param update the new value
</span><span class="cm">* @return {@code true} if successful. False return indicates that
</span><span class="cm">* the actual value was not equal to the expected value.
</span><span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">compareAndSet</span><span class="o">(</span><span class="n">V</span> <span class="n">expect</span><span class="o">,</span> <span class="n">V</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="n">expect</span><span class="o">,</span> <span class="n">update</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç»§ç»­å¾€ä¸‹çœ‹<code>unsafe.compareAndSwapObject</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">compareAndSwapObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">long</span> <span class="n">var2</span><span class="o">,</span> <span class="n">Object</span> <span class="n">var4</span><span class="o">,</span> <span class="n">Object</span> <span class="n">var5</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™å·²ç»æ˜¯nativeæ–¹æ³•äº†ï¼Œæ›´è¯¦ç»†çš„ä»£ç æ˜¯C++å®ç°çš„ã€‚ç»§ç»­å¾€ä¸‹çœ‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C++" data-lang="C++"><span class="n">UNSAFE_ENTRY</span><span class="p">(</span><span class="n">jboolean</span><span class="p">,</span> <span class="n">Unsafe_CompareAndSwapObject</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">unsafe</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">offset</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">e_h</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">x_h</span><span class="p">))</span>
  <span class="n">UnsafeWrapper</span><span class="p">(</span><span class="s">&#34;Unsafe_CompareAndSwapObject&#34;</span><span class="p">);</span>
  <span class="n">oop</span> <span class="n">x</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">x_h</span><span class="p">);</span> <span class="c1">// æ–°å€¼
</span><span class="c1"></span>  <span class="n">oop</span> <span class="n">e</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">e_h</span><span class="p">);</span> <span class="c1">// é¢„æœŸå€¼
</span><span class="c1"></span>  <span class="n">oop</span> <span class="n">p</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
  <span class="n">HeapWord</span><span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">HeapWord</span> <span class="o">*</span><span class="p">)</span><span class="n">index_oop_from_field_offset_long</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span><span class="c1">// åœ¨å†…å­˜ä¸­çš„å…·ä½“ä½ç½®
</span><span class="c1"></span>  <span class="n">oop</span> <span class="n">res</span> <span class="o">=</span> <span class="n">oopDesc</span><span class="o">::</span><span class="n">atomic_compare_exchange_oop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span><span class="c1">// è°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•
</span><span class="c1"></span>  <span class="n">jboolean</span> <span class="n">success</span>  <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">e</span><span class="p">);</span>  <span class="c1">// å¦‚æœè¿”å›çš„resç­‰äºeï¼Œåˆ™åˆ¤å®šæ»¡è¶³compareæ¡ä»¶ï¼ˆè¯´æ˜resåº”è¯¥ä¸ºå†…å­˜ä¸­çš„å½“å‰å€¼ï¼‰ï¼Œä½†å®é™…ä¸Šä¼šæœ‰ABAçš„é—®é¢˜
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="c1">// successä¸ºtrueæ—¶ï¼Œè¯´æ˜æ­¤æ—¶å·²ç»äº¤æ¢æˆåŠŸï¼ˆè°ƒç”¨çš„æ˜¯æœ€åº•å±‚çš„cmpxchgæŒ‡ä»¤ï¼‰
</span><span class="c1"></span>    <span class="n">update_barrier_set</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span> <span class="c1">// æ¯æ¬¡Referenceç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªWrite Barrieræš‚æ—¶ä¸­æ–­æ“ä½œï¼Œé…åˆåƒåœ¾æ”¶é›†å™¨
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="n">UNSAFE_END</span>
</code></pre></td></tr></table>
</div>
</div><p>å†å¾€ä¸‹çœ‹ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>atomic_compare_exchange_oop</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kr">inline</span> <span class="n">oop</span> <span class="n">oopDesc</span><span class="o">::</span><span class="n">atomic_compare_exchange_oop</span><span class="p">(</span><span class="n">oop</span> <span class="n">exchange_value</span><span class="p">,</span>
                                                <span class="k">volatile</span> <span class="n">HeapWord</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
                                                <span class="n">oop</span> <span class="n">compare_value</span><span class="p">,</span>
                                                <span class="kt">bool</span> <span class="n">prebarrier</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">UseCompressedOops</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// å¦‚æœä½¿ç”¨äº†å‹ç¼©æ™®é€šå¯¹è±¡æŒ‡é’ˆ(CompressedOops)ï¼Œæœ‰ä¸€ä¸ªé‡æ–°ç¼–è§£ç çš„è¿‡ç¨‹
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">prebarrier</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">update_barrier_set_pre</span><span class="p">((</span><span class="n">narrowOop</span><span class="o">*</span><span class="p">)</span><span class="n">dest</span><span class="p">,</span> <span class="n">exchange_value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// encode exchange and compare value from oop to T
</span><span class="c1"></span>    <span class="n">narrowOop</span> <span class="n">val</span> <span class="o">=</span> <span class="n">encode_heap_oop</span><span class="p">(</span><span class="n">exchange_value</span><span class="p">);</span> <span class="c1">// æ–°å€¼
</span><span class="c1"></span>    <span class="n">narrowOop</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">encode_heap_oop</span><span class="p">(</span><span class="n">compare_value</span><span class="p">);</span> <span class="c1">// é¢„æœŸå€¼
</span><span class="c1"></span>
    <span class="n">narrowOop</span> <span class="n">old</span> <span class="o">=</span> <span class="p">(</span><span class="n">narrowOop</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">narrowOop</span><span class="o">*</span><span class="p">)</span><span class="n">dest</span><span class="p">,</span> <span class="n">cmp</span><span class="p">);</span> <span class="c1">// è¿™é‡Œè°ƒç”¨çš„æ–¹æ³•è§æ–‡ç« æœ€åï¼Œå› ä¸ºè¢«å‹ç¼©åˆ°äº†32ä½ï¼Œæ‰€ä»¥å¯ä»¥ç”¨intæ“ä½œ  
</span><span class="c1"></span>    <span class="c1">// decode old from T to oop
</span><span class="c1"></span>    <span class="k">return</span> <span class="nf">decode_heap_oop</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prebarrier</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">update_barrier_set_pre</span><span class="p">((</span><span class="n">oop</span><span class="o">*</span><span class="p">)</span><span class="n">dest</span><span class="p">,</span> <span class="n">exchange_value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">oop</span><span class="p">)</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="n">exchange_value</span><span class="p">,</span> <span class="p">(</span><span class="n">oop</span><span class="o">*</span><span class="p">)</span><span class="n">dest</span><span class="p">,</span> <span class="n">compare_value</span><span class="p">);</span> <span class="c1">// å¯ä»¥çœ‹åˆ°è¿™é‡Œç»§ç»­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å†å¾€ä¸‹çœ‹<code>Atomic::cmpxchg</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kr">inline</span> <span class="n">jlong</span>    <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg</span>    <span class="p">(</span><span class="n">jlong</span>    <span class="n">exchange_value</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">jlong</span><span class="o">*</span>    <span class="n">dest</span><span class="p">,</span> <span class="n">jlong</span>    <span class="n">compare_value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">::</span><span class="n">is_MP</span><span class="p">();</span>
  <span class="n">jint</span> <span class="n">ex_lo</span>  <span class="o">=</span> <span class="p">(</span><span class="n">jint</span><span class="p">)</span><span class="n">exchange_value</span><span class="p">;</span>
  <span class="n">jint</span> <span class="n">ex_hi</span>  <span class="o">=</span> <span class="o">*</span><span class="p">(</span> <span class="p">((</span><span class="n">jint</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">exchange_value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
  <span class="n">jint</span> <span class="n">cmp_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">jint</span><span class="p">)</span><span class="n">compare_value</span><span class="p">;</span>
  <span class="n">jint</span> <span class="n">cmp_hi</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span> <span class="p">((</span><span class="n">jint</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">compare_value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">push</span> <span class="n">ebx</span>
    <span class="n">push</span> <span class="n">edi</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">cmp_lo</span>
    <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">cmp_hi</span>
    <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">dest</span>
    <span class="n">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ex_lo</span>
    <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ex_hi</span>
    <span class="n">LOCK_IF_MP</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
    <span class="n">cmpxchg8b</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">edi</span><span class="p">]</span>
    <span class="n">pop</span> <span class="n">edi</span>
    <span class="n">pop</span> <span class="n">ebx</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åç»ˆäºçœ‹åˆ°äº†<code>cmpxchg8b</code> æ„ä¸º compare and exchange 8byteï¼Œæ¯”è¾ƒå¹¶äº¤æ¢8å­—èŠ‚ã€‚8å­—èŠ‚ï¼Œå³64bitï¼Œä¸ªäººè®¤ä¸ºæ­£å¥½æ˜¯64bitçš„å¯»å€å¯¹è±¡ã€‚</p>
<hr>
<p>å‚è€ƒæ–‡ç« ï¼š</p>
<ol>
<li><a href="https://blog.csdn.net/qqqqq1993qqqqq/article/details/75211993">å¹¶å‘å®æˆ˜</a></li>
<li><a href="http://www.cnblogs.com/Mainz/p/3556430.html">ä¸ºä»€ä¹ˆvolatileä¸èƒ½ä¿è¯åŸå­æ€§è€ŒAtomicå¯ä»¥ï¼Ÿ</a></li>
</ol>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/2017-06-06-real-time-pose-estimation-with-aruco/" title="Previous post (older)">
            <span>Previous</span>
            Real-time-pose-estimation-with-aruco
            </a>
        
        
        
        <a rel="next" href="/post/2019-08-12-understand-kubernetes/" title="Next post (newer)">
            <span>Next</span>
            Understand-Kubernetes
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>